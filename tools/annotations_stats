#! /usr/bin/env python

import logging
logging.basicConfig(level=logging.INFO)

import argparse
import sys
import os
import yaml
import csv

from timeline import InterraterReliability, TASKENGAGEMENT, SOCIALENGAGEMENT, SOCIALATTITUDE

CHILDCHILD = "childchild"
CHILDROBOT = "childrobot"

istty = sys.stdout.isatty()

def ddhhmmss(sec):
    return "%dd %02d:%02d:%02d" % (sec//(3600*24), (sec%(3600*24))//3600,((sec%(3600*24))%3600)//60, ((sec%(3600*24))%3600)%60)

def hhmmss(sec):
    return "%02d:%02d:%02d" % (sec//3600,(sec%3600)//60, (sec%3600)%60)

def mmss(sec):
    return "%02d:%02d" % ((sec%3600)//60, (sec%3600)%60)

def normalize_name(name):
    return name.lower().strip("0123456789") 

class Child:

    def __init__(self, participant):
        self.age = participant["age"]
        self.gender = participant["gender"]
        self.id = participant["id"]
        self.details = participant["details"]
        self.nb_frames_visible = float('nan')
        self.percent_visible = float('nan')

    def csvrow(self):
        return [self.age, self.gender]


class Recording:

    def __init__(self,id, experiment, bagfile, annotations):

        self.id = id

        self.experiment = experiment
        self.bagfile = bagfile
        self.annotations = annotations

        self.cdt = self.experiment["condition"]

        # to have the proper list of annotators, turn names lower-case and remove trailing numbers to
        # remove all the cases where the same annotators re-coded the same video as 'scott' or 'Scott2' for instance
        self.annotators = set([normalize_name(name) for name in self.annotations.keys()])

        self.double_coded = True if len(self.annotators) > 1 else False

        if self.double_coded:
            annotators = self.annotations.keys()
            self.irr_task = InterraterReliability(TASKENGAGEMENT,
                                                  self.annotations[annotators[0]],
                                                  self.annotations[annotators[1]],
                                                  self.cdt)

            self.irr_social = InterraterReliability(SOCIALENGAGEMENT,
                                                  self.annotations[annotators[0]],
                                                  self.annotations[annotators[1]],
                                                  self.cdt)

            self.irr_attitude = InterraterReliability(SOCIALATTITUDE,
                                                  self.annotations[annotators[0]],
                                                  self.annotations[annotators[1]],
                                                  self.cdt)


        self.duration = self.bagfile["duration"]
        if self.cdt == CHILDCHILD:
            self.duration *= 2

        self.children = [Child(self.experiment["purple-participant"])]
        self.avg_age = self.children[0].age

        self.nb_annotations = 0
        total_episodes_duration = 0

        for coder, coded in self.annotations.items():
            self.nb_annotations += len(coded["purple"])
            for a in coded["purple"]:
                for atype, ts in a.items():
                    total_episodes_duration += ts[1]-ts[0]
            if self.cdt == CHILDCHILD:
                self.nb_annotations += len(coded["yellow"])
                for a in coded["yellow"]:
                    for atype, ts in a.items():
                        total_episodes_duration += ts[1]-ts[0]

        self.avg_episode_duration = total_episodes_duration / self.nb_annotations


        self.annotation_rate = self.nb_annotations * 1. / self.duration

        if self.cdt == CHILDCHILD:
            self.children.append(Child(self.experiment["yellow-participant"]))
            self.avg_age = (self.children[0].age + self.children[1].age) / 2.0


    def avg_annotations_duration(self, annotations):
        nb_annotations = len(annotations)
        total_episodes_duration = 0

        for a in annotations:
            for atype, ts in a.items():
                total_episodes_duration += ts[1]-ts[0]

        return total_episodes_duration / nb_annotations



    def overview(self):
        res = "Recording %s -- %s -- duration: %s\n" % (self.id, self.cdt, mmss(self.duration))

        total=0
        for coder, coded in self.annotations.items():
            res += "\tCoder %s:\n" % coder
            res += "\t  - %d events for purple (%.1f per min)\n"% (len(coded["purple"]), len(coded["purple"])*60/self.duration)
            res += "\t  - avg duration of annotated events: %.1fs\n" % self.avg_annotations_duration(coded["purple"])
            total+=len(coded["purple"])
            if self.cdt == CHILDCHILD:
                res += "\t  - %d events for yellow (%.1f per min)\n"% (len(coded["yellow"]), len(coded["yellow"])*60/self.duration)
                res += "\t  - avg duration of annotated events: %.1fs\n" % self.avg_annotations_duration(coded["yellow"])
                total+=len(coded["yellow"])

        res += "Total # of annotations: %d\n" % total
        return res

    def csvrows(self):
        rows = []
        for coder, coded in self.annotations.items():
            rows.append([self.id, self.cdt, self.duration, normalize_name(coder), "purple", len(coded["purple"]), self.avg_annotations_duration(coded["purple"])])
            if self.cdt == CHILDCHILD:
                rows.append([self.id, self.cdt, self.duration, normalize_name(coder), "yellow", len(coded["yellow"]), self.avg_annotations_duration(coded["yellow"])])
        return rows

    def __repr__(self):
        return self.id




class Dataset:

    def __init__(self, root):

        self.dataset = []

        self.total_nb_recordings = 0

        for dirpath, dirs, files in os.walk(root, topdown=False):
            for name in files:
                fullpath = os.path.join(dirpath, name)
                if name == "experiment.yaml":
                    if dirpath.split(os.sep)[-1].startswith("exclude_"):
                        logging.info("%s has been excluded" % fullpath)
                        continue
                    logging.debug("Processing %s" % fullpath)
                    self.total_nb_recordings += 1
                    self.processpath(dirpath)

        self.dataset.sort(key=lambda val: repr(val))

        self.total_duration = 0
        self.nb_children = 0
        self.nb_childchild = 0
        self.nb_childrobot= 0

        for record in self.dataset:
            self.total_duration += record.duration
            if record.cdt == CHILDCHILD:
                self.nb_childchild += 1
            elif record.cdt == CHILDROBOT:
                self.nb_childrobot += 1

    def overview(self):

        print("\nOVERVIEW")
        print("path" + " " * 19 + "  timestamp   len   condition  C1    C2")

        double_coded = 0
        for r in self.dataset:
            if r.double_coded:
                double_coded += 1
            sys.stdout.write(r.overview())

        print("\n")
        print("Total nb recordings: %d" % self.total_nb_recordings)
        print("Total nb recordings with annotations: %d" % len(self.dataset))
        print("Total nb recordings double-coded: %d (%.2f%% of whole dataset)" % (double_coded, double_coded * 100. / self.total_nb_recordings))

        total_annotations=0
        total_duration=0
        avg_episode_duration=0

        for r in self.dataset:
            total_annotations += r.nb_annotations
            total_duration += r.duration
            avg_episode_duration += r.avg_episode_duration

        print("\n\nTotal duration: %.1f (%s)" % (total_duration, hhmmss(total_duration)))
        print("Total # annotations: %d" % total_annotations)
        print("Average annotations per record: %.1f" % (total_annotations/len(self.dataset)))
        print("Average annotations per minute: %.1f" % (total_annotations*60./total_duration))
        print("Average annotations duration: %.1fsec" % (avg_episode_duration/len(self.dataset)))


        print("\n\nInter-rater reliability for double-coded recordings:")
        for r in self.dataset:
            if r.double_coded:
                print("%s (%s) -- annotators: %s" % (r.id, r.cdt, r.annotations.keys()))
                print("%d annotations, %.1f annotations/min" % (r.nb_annotations, 60*r.annotation_rate))
                print("\tTask engagement: Krippendorff's alpha: %.2f --  %.2f%% agreement" % \
                                    (r.irr_task.alpha,
                                     r.irr_task.percentage_agreement))
                print("\tSocial engagement: Krippendorff's alpha: %.2f --  %.2f%% agreement" % \
                                    (r.irr_social.alpha,
                                     r.irr_social.percentage_agreement))
                print("\tSocial attitude: Krippendorff's alpha: %.2f --  %.2f%% agreement" % \
                                    (r.irr_attitude.alpha,
                                     r.irr_attitude.percentage_agreement))

    def processpath(self, path):

        with open(os.path.join(path, "experiment.yaml"), 'r') as yml:
            expe = yaml.load(yml)

        with open(os.path.join(path, "freeplay.bag.yaml"), 'r') as yml:
            bagfile = yaml.load(yml)

        annotations = {}
        for file in os.listdir(path):
            if file.startswith("freeplay.annotations.") and file.endswith(".yaml"):
                annotationfile = os.path.join(path, file)
                annotator = file.split("freeplay.annotations.")[1].split(".yaml")[0]

                with open(annotationfile, 'r') as yml:
                    annotations[annotator] = yaml.load(yml)

        if len(annotations) > 0:
            #logging.info("%s: %s annotations" % (path, len(annotations)))
            record = Recording(path, expe, bagfile, annotations)
            self.dataset.append(record)

        else:
            logging.warn("%s: No annotations!!" % path)

    def write_csv(self, csvfile):
        writer = csv.writer(csvfile)
        writer.writerow(["id", "condition", "duration", "coder", "child", "nb_annotations","avg_episode_duration"])
        for r in self.dataset:
            for row in r.csvrows():
                writer.writerow(row)


if __name__ == "__main__":

    parser = argparse.ArgumentParser(description='PInSoRo Dataset -- Annotations Statistics')
    parser.add_argument("path", help="root path of the dataset -- recordings are recursively looked for from this path")
    parser.add_argument("-c", "--csv", nargs='?', type=argparse.FileType('wb'), default=False, const=sys.stdout, help="save the dataset statistics to the specified CSV file (default to stdout)")

    args = parser.parse_args()

    dataset = Dataset(args.path)
    if args.csv:
        dataset.write_csv(args.csv)
    else:
        dataset.overview()
